      SUBROUTINE ELSYI(veh, thk, mod, poi, wxp, wyp, oxp, oyp, 
     1 nlay, nwhl, nloc)
      use, intrinsic :: iso_fortran_env, only : dp => real64
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
      COMMON E(5),V(5),DI(5),R(100),Z(10),EX(32),
     1        CDAB(5,736),AJ1(184),RJ1(184),RJ0(184),
     2        VSE,SSE,RDP,VDP,RSE,TSE,ST1,ST2,ST3,ST4,
     3        WR,WZ,WRL,RL,PRES,RLP,TST1,TST2,TST3,TST4,
     4        NSYM,NSY,NLSW,NBZ,NGQP,NX,NEX,NR,NRC,NZ,NZC,MSW,
     5        NEL,NEI,NI,NBLL,LAY,NTEST,NTSI,ITS,IND,NAB,NBZC,
     6        KSW1,KSW2,KSW3,KSW4,KSW5,KSW6,KSW7,KSW8,KSW9
      COMMON XL(10),YL(10),XP(10),YP(10),LAYZ(10),
     1  ANS(6,100,10),AS(9,3,10),TITLE(40),IXR(100),NLD,NXY,IO

      real(dp) :: veh(2)
      real(dp) :: thk(5)
      real(dp) :: mod(5)
      real(dp) :: poi(5)
      real(dp) :: wxp(10)
      real(dp) :: wyp(10)
      real(dp) :: oxp(10)
      real(dp) :: oyp(10)
      integer :: nlay
      integer :: nwhl
      integer :: nloc

C *** EXCLUSIVE ROUTINE ARRAYS
      DIMENSION TH(5),XR(100)

      IND1=0
   45 KSW44=1
C *** INPUT SYSTEM PARAMETERS
C      READ(5,*) NEL,NLD,NXY,NZ
      NEL = nlay
      NLD = nwhl
      NXY = nloc
      NZ = 1
C 1002 FORMAT ( 4I5 )
C *** TEST SYSTEM PARAMETERS
C *** TEST NUMBER OF ELASTIC LAYERS (NEL)
C *** SET NUMBER OF LAYERS SWITCH (NLSW)
      IF(NEL-1) 9003,7,6
C *** NLSW=3 FOR 1 ELASTIC LAYER
    7 NLSW=3
      GO TO 8
    6 IF(NEL-3) 3,9,9
C *** NLSW=2 FOR 2 ELASTIC LAYERS
    3 NLSW=2
      GO TO 8
C *** NLSW=1 FOR 3 OR MORE ELASTIC LAYERS
    9 NLSW=1
C   11 IF(NEL-5) 8,8,9003
C *** TEST NUMBER OF LOADS (NLD)
C    8 IF(NLD) 9009,9009,10
C   10 IF(NLD-10) 4,4,9009
C *** TEST NUMBER OF XY VALUES (NXY)
C    4 IF(NXY) 9004,9004,5
C    5 IF(NXY-5) 12,12,9004
C *** TEST NUMBER OF Z VALUES (NZ)
C   12 IF(NZ) 9005,9005,14
C   14 IF(NZ-10) 16,16,9005
C *** INPUT LAYER DATA AND TEST VALUES
    8 DO 54 K1=1,NEL
      LN = K1
      TH(K1) = thk(LN)
      V(K1) = poi(LN)
      E(K1) = mod(LN)
      NFRIC = 1
C      READ(5,*) LN,TH(K1),V(K1),E(K1),NFRIC
C 1004 FORMAT ( I5,2F5.0,F10.0,4X,A2)
      IF(LN-K1) 9007,44,9007
   44 IF(E(K1)) 9007,9007,46
   46 IF(V(K1)) 9007,9007,47
   47 IF(V(K1)-.99) 48,48,9007
   48 IF(K1-NEL) 52,50,9007
   52 IF(TH(K1)) 9007,9007,54
C *** TEST BASE CONDITION
   50 IF(TH(K1)) 9007,18,22
C *** SET BASE CONDITION TO ELASTIC
   18 NI=NEL-1
      NX=2
      KSW1=1
      GO TO 24
C *** SET BASE CONDITION TO RIGID
   22 NI=NEL
      NX=1
      KSW1=2
C *** CHECK BASE INTERFACE CONDITION
      IF(NFRIC .NE. 1) GO TO 53
      KSW2=1
      GO TO 24
   53 IF(NFRIC .NE. 2) GO TO 9010
      KSW2=2
   24 NEI=NEL-1
   54 CONTINUE
C *** INPUT NORMAL LOAD VALUES
C      READ(5,*) FOR,PRES,RL
      FOR=veh(1)
      PRES=veh(2)
      RL=0.0 
C *** TEST NORMAL LOAD VALUES
C 1003 FORMAT ( 3F10.0 )
C *** TEST FOR TWO OUT OF THREE AND NEGATIVE VALUES
C *** TEST FORCE VALUE (FOR)
      IF(FOR) 9006,26,28
C *** TEST PRESSURE VALUE (PRES)
   26 IF(PRES) 9006,9006,30
   28 IF(PRES) 9006,32,34
C *** TEST RADIUS OF LOAD VALUE (RL)
   30 IF(RL) 9006,9006,36
   32 IF(RL) 9006,9006,38
   34 IF(RL) 9006,40,9006
C *** COMPUTE MISSING VALUE
   36 FOR=PRES*RL**2/0.31830987
      GO TO 42
   38 PRES=0.31830987*FOR/(RL**2)
      GO TO 42
   40 RL=SQRT(0.31830987*FOR/PRES)
C *** INPUT NORMAL LOAD COORDINATES
C   42 READ(5,*) (XL(K1),YL(K1),K1=1,NLD )
   42 do K1=1,NLD
        XL(K1)=wxp(K1)
        YL(K1)=wyp(K1)
      end do  
C 1025 FORMAT ( 2F10.0 )
C *** INPUT COORDINATES FOR XY POINTS
C      READ(5,*) (XP(K1),YP(K1),K1=1,NXY)
      do K1=1,NXY
        XP(K1)=oxp(K1)
        YP(K1)=oyp(K1)
      end do  
C *** INPUT Z VALUES AND TEST
C      READ(5,*) (Z(K1),K1=1,NZ)
      Z(1)=0.0
C 1005 FORMAT (10F5.0 )
C *** CHECK FOR NEGATIVE Z VALUE
C      DO 58 K1=1,NZ
C      IF(Z(K1)) 9008,58,58
C   58 CONTINUE
C *** SORT Z VALUES IN ORDER OF INCREASING VALUE
      IF(NZ-1) 67,67,61
   61 K1=NZ-1
      DO 65 K2=1,K1
      K3=K2+1
      DO 65 K4=K3,NZ
      IF(Z(K2)-Z(K4)) 65,9008,63
   63 TEMP=Z(K2)
      Z(K2)=Z(K4)
      Z(K4)=TEMP
   65 CONTINUE
C *** DEVELOP DEPTH TO INTERFACE ARRAY
   67 GO TO ( 77,77,75 ),NLSW
   75 DI(1)=TH(1)
      EX(1)=0.0
      EX(2)=2.0*TH(1)
      GO TO 85
   77 DI(1)=TH(1)
      IF(NI-1) 80,80,76
   76 DO 78 K1=2,NI
      DI(K1)=DI(K1-1)+TH(K1)
   78 CONTINUE
C *** DEVELOP EXPONENT TEST ARRAY
   80 NEX=2**NI
      K1=1
      K2=1
      EX(1)=0.0
      DO 84 K3=1,NEL
      K4=NEL+1-K3
      TEMP=2.0*TH(K4)
      DO 82 K5=1,K2
      K1=K1+1
      EX(K1)=TEMP+EX(K5)
   82 CONTINUE
      K2=K2*2
   84 CONTINUE
   85 GO TO ( 87,83),KSW1
C *** ELIMINATE Z VALUES .GT. DEPTH TO RIGID BASE
C     AND ADJUST NUMBER OF Z VALUES
   83 DINI=DI(NI)
      NZT=NZ
      DO 89 K1=1,NZ
      K2=NZ-K1+1
      IF(DINI+0.0001-Z(K2)) 95,89,89
   95 NZT=NZT-1
   89 CONTINUE
      NZ=NZT
C *** TEST V(NEL) NEAR 0.75
      IF(V(NEL)-0.748 ) 87,87,81
   81 IF(V(NEL)-0.752) 9007,87,87
C *** DEVELOP R ARRAY BY LOAD WITHIN XY POINT
   87 NXR=NXY*NLD
      K1=1
      DO 17 K2=1,NXY
      XPI=XP(K2)
      YPI=YP(K2)
      DO 17 K3=1,NLD
      XR(K1)=SQRT((YPI-YL(K3))**2+(XPI-XL(K3))**2)
      K1=K1+1
   17 CONTINUE
C *** DEVELOP R ARRAY IN INCREASING ORDER WITHOUT
C     DUPLICATE OR NEAR DUPLICATE VALUES
      NR=0
      K1=1
      R(1)=XR(1)
   19 NR=NR+1
   20 K1=K1+1
      IF(K1 .GT. NXR) GO TO 25
      RT=XR(K1)
C *** TEST FOR DUPLICATE OR NEAR DUPLICATE VALUES
      DO 23 K2=1,NR
      IF(ABS(RT-R(K2)) .LE. 0.02) GO TO 20
   23 CONTINUE
C *** INSERT VALUE IN PROPER ORDER
      DO 35 K2=1,NR
      K3=NR+1-K2
      IF(RT .LT. R(K3)) GO TO 33
      R(K3+1)=RT
      GO TO 19
   33 R(K3+1)=R(K3)
   35 CONTINUE
      R(K3)=RT
      GO TO 19
C
C *** DEVELOP IXR ARRAY AS A POINTER
   25 DO 31 K1=1,NXR
      XRI=XR(K1)
      DO 29 K2=1,NR
      IF(ABS(XRI-R(K2)) .GT. 0.02) GO TO 29
      IXR(K1)=K2
      GO TO 31
   29 CONTINUE
CADF       WRITE(IO,1010)
CADF  1010 FORMAT ( 1H ,12HERROR IN IRX )
      STOP
   31 CONTINUE
      IF(ABS(RL-R(1))-0.0001) 86,86,72
   72 IF(RL-R(1)) 88,86,86
   86 WRL=RL
      GO TO 90
   88 WRL=R(1)
   90 WR=R(1)
      IF(WR-0.0001) 91,91,92
   91 WR=0.0
      KSW3=2
      GO TO 93
   92 KSW3=1
   93 NRC=1
C *** WITH SORTED Z VALUES - ONLY TEST ONE VALUE
C *** DETERMINE BACK SUBSTITION LIMIT
      ZT=Z(NZ)
      DO 71 K1=1,NEI
      NBLL=K1
      IF(ZT-DI(K1)) 73,73,71
   71 CONTINUE
      NBLL=NEL
C *** SET RELATIVE (PSI), OR ABSOLUTE OUTPUT
   73 IF(IND1) 96,97,96
   96 RLP=RL
      GO TO 94
   97 RLP=RL*PRES
C *** OUTPUT ELASTIC SYSTEM DESCRIPTION
   94 GO TO ( 51,51,57),NLSW
   51 DO 60 K1=1,NEI
   60 CONTINUE
C   57 GO TO ( 62,64),KSW1
C   62 GO TO 66
C   64 GO TO (56,59),KSW2
C      GO TO 66
   57 RETURN
C *** INPUT DATA ERROR TRAP
C *** SET ERROR INDICATOR
 9003 NER=1
      GO TO 8001
C 9004 NER=2
C      GO TO 8001
C 9005 NER=3
C      GO TO 8001
 9006 NER=4
      GO TO 8001
 9007 NER=5
      GO TO 8001
 9008 NER=6
      GO TO 8001
C 9009 NER=7
C      GO TO 8001
 9010 NER=8
C *** COMMON ERROR OUTPUT 1
C *** ERROR CONDITION OUTPUT
 8001 NSY=NSY+1
      IF(NSY-NSYM) 45,45,69
C    69 STOP
   69 RETURN
      END
